<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>somber chat</title>
    <style>
        body,
        html {
            height: 100%;
        }

        * {
            font-family: sans-serif;
            margin: 0;
            padding: 0;
        }

        h1 {
            padding: 5px 10px;
        }

        #chatwrapper {
            padding: 10px;
            margin: 10px;
            border: 1px solid #333;
            border-radius: 2px;
        }

        #chatroom,
        #chatroom {
            margin: 5px;
        }

        #whiteboard {
            cursor: crosshair;
            position: fixed;
        }
    </style>
</head>

<body>
    <h1>o r i m</h1>

    <div id="chatwrapper">
        <h5>Chat</h5>
        <div id="chatroom">

        </div>
        <form id="chatbox">
            <input name="chatinput" type="text" placeholder="Say something..."></input>
            <button type="submit">Send</button>
        </form>
    </div>

    <canvas id="whiteboard">
        Sorry, your browser does not support HTML5 canvas technology.
    </canvas>

    <script type="text/javascript">
        let id = location.pathname.split("/")[2];
        let ws = new WebSocket("ws://localhost:8080/ws/" + id);
        let $board = document.getElementById("chatroom");
        let $chatbox = document.getElementById("chatbox");
        var $myCanvas, ctx;

        const handleChatMessage = (message) => {
            let node = document.createElement("p");
            node.textContent = message.user_name + ": " + message.content.text;
            $board.append(node);
        }

        $chatbox.addEventListener("submit", (evt) => {
            evt.preventDefault();
            let input = evt.target.elements["chatinput"]
            let msg = JSON.stringify({
                type: "chat",
                payload: {
                    userId: 120930,
                    text: input.value,
                    sentAt: new Date(),
                },
            });
            ws.send(msg);
            input.value = "";
        })

        ws.onopen = function () {
            console.log("let's start");
        }

        ws.onmessage = function (evt) {
            let message = JSON.parse(evt.data);

            switch (message.content.type) {
                case "chat":
                    handleChatMessage(message);
                    break;
                case "DrawInstruction":
                switch (message.content.action) {
                    case "start":
                        ctx.beginPath();
                        var canvasX = message.content.x;
                        var canvasY = message.content.y;
                        ctx.moveTo(canvasX, canvasY);
                        break;
                    case "stroke":
                        var canvasX = message.content.x;
                        var canvasY = message.content.y;
                        ctx.lineTo(canvasX, canvasY);
                        ctx.strokeStyle = strokeColor;
                        ctx.stroke();
                        break;
                    case "finish":
                        ctx.closePath();
                        break;
                }
                break;
                default:
                    console.warn("unknown content type: ", message.content.type)
            }
        }

        ws.onclose = function () {
            console.log("on close");
        }

        let strokeColor = "#333";
        const sendDrawInstruction = (evt) => {
            evt.type = "DrawInstruction";
            let msg = JSON.stringify(evt);
            ws.send(msg);
        }

        window.onload = function () {
            $myCanvas = document.getElementById("whiteboard");
            ctx = $myCanvas.getContext("2d");

            // Fill Window Width and Height
            $myCanvas.width = window.innerWidth;
            $myCanvas.height = window.innerHeight;

            // Set Background Color
            ctx.fillStyle = "#fff";
            ctx.fillRect(0, 0, $myCanvas.width, $myCanvas.height);

            // Mouse Event Handlers
            if ($myCanvas) {
                var isDown = false;
                var canvasX, canvasY;
                ctx.lineWidth = 5;

                $myCanvas.addEventListener("mousedown", e => {
                    isDown = true;
                    ctx.beginPath();
                    canvasX = e.pageX - $myCanvas.offsetLeft;
                    canvasY = e.pageY - $myCanvas.offsetTop;
                    ctx.moveTo(canvasX, canvasY);
                    sendDrawInstruction({
                        x: canvasX,
                        y: canvasY,
                        color: strokeColor,
                        action: "start"
                    });
                });

                $myCanvas.addEventListener("mousemove", e => {
                    if (isDown === true) {
                        canvasX = e.pageX - $myCanvas.offsetLeft;
                        canvasY = e.pageY - $myCanvas.offsetTop;
                        ctx.lineTo(canvasX, canvasY);
                        ctx.strokeStyle = strokeColor;
                        ctx.stroke();
                        sendDrawInstruction({
                            x: canvasX,
                            y: canvasY,
                            color: strokeColor,
                            action: "stroke"
                        });
                    }
                });

                $myCanvas.addEventListener("mouseup", e => {
                    isDown = false;
                    ctx.closePath();
                    sendDrawInstruction({
                        x: 0,
                        y: 0,
                        color: strokeColor,
                        action: "finish",
                    });
                });
            }

            // Touch Events Handlers
            draw = {
                started: false,
                start: function (evt) {

                    ctx.beginPath();
                    ctx.moveTo(
                        evt.touches[0].pageX,
                        evt.touches[0].pageY
                    );

                    this.started = true;

                },
                move: function (evt) {

                    if (this.started) {
                        ctx.lineTo(
                            evt.touches[0].pageX,
                            evt.touches[0].pageY
                        );

                        ctx.strokeStyle = "#000";
                        ctx.lineWidth = 5;
                        ctx.stroke();
                    }

                },
                end: function (evt) {
                    this.started = false;
                }
            };

            // Touch Events
            $myCanvas.addEventListener('touchstart', draw.start, false);
            $myCanvas.addEventListener('touchend', draw.end, false);
            $myCanvas.addEventListener('touchmove', draw.move, false);

            // Disable Page Move
            document.body.addEventListener('touchmove', function (evt) {
                evt.preventDefault();
            }, false);
        };
    </script>


</body>

</html>